<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>TSV Virac Chatbot</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  
  <style>
    :root {
      --primary-orange: #ff7e29;
      --secondary-orange: #ff9e4d;
      --dark-gray: #1a1a1a;
      --light-gray: #f5f5f5;
      --card-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
      --transition-ease: all 0.3s ease;
    }

    body {
      font-family: 'Inter', sans-serif;
      background-color: var(--light-gray);
      color: var(--dark-gray);
      display: flex;
      flex-direction: column;
      min-height: 100vh;

                 /* Watermark background */
        background-image:

            url("data:image/svg+xml;charset=UTF-8,<svg xmlns='http://www.w3.org/2000/svg' width='300' height='150'><text x='50%' y='50%' font-size='40' fill='rgba(255,255,255,0.05)' font-family='Poppins' text-anchor='middle' dominant-baseline='middle' transform='rotate(-30,150,75)'>Virac TSV</text></svg>");
        background-repeat: repeat;
        background-size: 300px 150px;
    }

    /* Navbar */
    .navbar {
      background: var(--dark-gray);
      border-bottom: 3px solid var(--primary-orange);
    }
    .navbar-brand img {
      filter: drop-shadow(0 0 5px rgba(255, 126, 41, 0.5));
    }
    .nav-link {
      color: white !important;
      font-weight: 500;
      transition: var(--transition-ease);
      padding: 0.5rem 1rem !important;
      position: relative;
    }
    .nav-link::after {
      content: '';
      position: absolute;
      bottom: 0;
      left: 50%;
      width: 0;
      height: 2px;
      background-color: var(--primary-orange);
      transition: var(--transition-ease);
      transform: translateX(-50%);
    }
    .nav-link:hover::after {
      width: 80%;
    }
    .nav-link.active, .nav-link.active:hover {
      color: var(--primary-orange) !important;
    }

    /* Section Title */
    .section-title {
      font-size: 2.5rem;
      position: relative;
      padding-bottom: 10px;
      margin-bottom: 50px;
      text-align: center;
    }
    .section-title::after {
      content: '';
      position: absolute;
      bottom: 0;
      left: 50%;
      transform: translateX(-50%);
      width: 80px;
      height: 4px;
      background-color: var(--primary-orange);
      border-radius: 2px;
    }

    /* Chat Area */
    .chat-container {
      flex: 1;
      display: flex;
      flex-direction: column;
      max-width: 900px;
      width: 100%;
      margin: 0 auto;
      padding: 0 15px;
    }
    #chatbox {
      flex: 1;
      background: white;
      padding: 20px;
      border-radius: 15px;
      box-shadow: var(--card-shadow);
      min-height: 500px;
      max-height: 70vh;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 15px;
      scroll-behavior: smooth;
    }
    .msg {
      padding: 12px 18px;
      border-radius: 18px;
      line-height: 1.5;
      max-width: 80%;
      word-wrap: break-word;
      animation: fadeIn 0.3s ease-in-out;
    }
    .msg.user {
      background-color: var(--primary-orange);
      color: white;
      align-self: flex-end;
      border-bottom-right-radius: 5px;
    }
    .msg.bot {
      background-color: #e9ecef;
      align-self: flex-start;
      border-bottom-left-radius: 5px;
      color: #343a40;
    }
    .msg strong {
      font-weight: 600;
    }

    /* Input Area */
    .input-area {
      max-width: 900px;
      margin: 20px auto;
      width: 100%;
      padding: 0 15px;
    }
    .input-group {
      box-shadow: var(--card-shadow);
      border-radius: 12px;
      overflow: hidden;
    }
    .input-area input {
      border: none;
      padding: 15px 20px;
      font-size: 1rem;
      border-radius: 0;
    }
    .input-area input:focus {
      box-shadow: none;
    }
    .input-area button {
      background-color: var(--primary-orange);
      color: white;
      border: none;
      padding: 15px 25px;
      font-weight: 600;
      transition: var(--transition-ease);
    }
    .input-area button:hover {
      background-color: #ff9e4d;
    }

    /* Footer */
    footer {
      background-color: var(--dark-gray);
      color: white;
      padding: 40px 0;
      margin-top: 4rem;
    }
    .footer-text {
      color: white;
    }

    /* Animations */
    @keyframes fadeIn {
      from {opacity: 0; transform: translateY(5px);}
      to {opacity: 1; transform: translateY(0);}
    }

    /* Responsive adjustments */
    @media (max-width: 768px) {
      .section-title {
        font-size: 2rem;
        margin-bottom: 30px;
      }
      .input-area .input-group > input, .input-area .input-group > button {
        height: 50px;
        font-size: 0.9rem;
      }
    }
  </style>
</head>
<body>

<nav class="navbar navbar-expand-lg sticky-top">
  <div class="container">
    <a class="navbar-brand" href="index.html">
      <img src="image/tsv_logo.png" alt="TSV Virac Logo" height="60" />
    </a>
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navMenu" aria-controls="navMenu" aria-expanded="false" aria-label="Toggle navigation">
      <i class="fa-solid fa-bars text-white"></i>
    </button>
    <div class="collapse navbar-collapse" id="navMenu">
      <ul class="navbar-nav ms-auto mb-2 mb-lg-0">
        <li class="nav-item"><a class="nav-link" href="index.html">Home</a></li>
        <li class="nav-item"><a class="nav-link" href="tsvsuguan-auto.html">Suguan</a></li>
        <li class="nav-item"><a class="nav-link active" aria-current="page" href="chatbot.html">Chat Bot</a></li>
        <li class="nav-item"><a class="nav-link" href="tsvgames.html">TSV Games (BETA)</a></li>
        <li class="nav-item"><a class="nav-link" href="member-panel.html">User Panel</a></li>
 
      </ul>
    </div>
  </div>
</nav>

<main class="container my-5 chat-container">
  <h2 class="section-title">ðŸ¤– Ask TSV Bot!</h2>
  <div id="chatbox"></div>
  <div class="input-area">
    <div class="input-group">
      <input type="text" id="userInput" class="form-control" placeholder="Ask something about TSV Virac..." />
      <button class="btn" type="button" onclick="chat()">Send</button>
    </div>
  </div>
</main>

<footer>
  <div class="container text-center">
    <p class="footer-text mb-0">&copy; 2025 KuysDrew Web Development Inc. All rights reserved.</p>
       <a href="privacy.html" class="btn btn-link text-decoration-none">Privacy Policy & Terms of Service</a>
  </div>
</footer>

  <!-- Botpress Inject Scripts -->
  <script src="https://cdn.botpress.cloud/webchat/v3.2/inject.js"></script>
  <script src="https://files.bpcontent.cloud/2025/08/22/06/20250822063030-NCUYH9BC.js" defer></script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<script>
  const botResponses = {
    "what is tsv": "TSV stands for Technical Support for Video-Streaming, which is composed of brethren who possess technical knowledge and skills. The Iglesia Ni Cristo conducts worship services that utilize modern technology. Through this technology, brethren are able to witness the leadership of the Executive Minister even without physically going to the local congregation. With the help of modern tools, the message of the Church Administration is delivered to the brethren more efficiently and effectively.",
    "who can attend tsv": "TSV is open to everyone, especially youth members from Virac and nearby barangays.",
    "what time is tsv": "TSV services are usually held in Midweek: Wednesday 6AM, Thursday 6AM (ENGLISH), Thursday 7PM (With Sign Language) During Weekend Saturday 6AM, Sunday 6AM (ENGLISH), PNK 8AM and 10AM (With Sign Language). Check with the bulletin board in Locale of Virac for the updated schedule",
    "schedule of worship service": "The Schedule of Worship Services are: During Midweek: Wednesday 6AM, Thursday 6AM (ENGLISH), Thursday 7PM (With Sign Language) During Weekend Saturday 6AM, Sunday 6AM (ENGLISH), PNK 8AM and 10AM (With Sign Language). Check with the bulletin board in Locale of Virac for the updated schedule",
    "how to confirm attendance": "You can confirm your attendance by signing in at the TSV attendance system using your assigned PIN code.",
    "where is the venue": "The TSV room is located at Locale of Virac, Male Dressing Room",
    "who are the leaders": "Due to the data privacy act of 2012. Please ask the resident minister regarding this matter.",
    "what should i wear": "Attendees are advised to wear modest and proper white sunday dress during TSV duties.",
    "what are the responsibilities of tsv members": "TSV members are responsible for setting up, monitoring, and maintaining video-streaming equipment during worship services. They ensure smooth transmission of audio and video, troubleshoot technical issues, and support the overall broadcast process of the Church events.",
    "how to join tsv" : "If you are interested in joining TSV, kindly approach your resident minister or TSV lead at the Locale of Virac. Applicants are usually screened based on their willingness to serve and basic technical knowledge, but training will also be provided.",
    "what equipment is used in tsv": "TSV uses various equipment including cameras, video switchers, audio mixers, streaming devices, computers, and monitors to ensure the quality and reliability of video-streamed worship services.",
    "is training provided for new tsv members": "Yes, training is provided for all new members. The training covers basic technical skills, equipment operation, troubleshooting procedures, and protocols followed during worship services.",
    "is there a dress code for tsv members": "Yes. TSV members are expected to wear proper white and black dress for women and polo for men, usually in accordance with the guidelines set by the local congregation or leadership, especially during worship services.",
    "what language is used in worship" : "Worship services supported by TSV are conducted in Filipino and English, and there are also sessions that include sign language interpretation to ensure accessibility for everyone.",
    "how to fix no sound during live stream": "Please check if the microphone or audio source is properly connected and not muted. Also, verify the audio input settings in your streaming software. If you are using a mixer, make sure the levels are set correctly and cables are secure.",
    "what to do if camera is not working": "Make sure the camera is properly connected to the computer or video switcher. Check if the device is recognized by your streaming software. Try restarting the software or using a different USB/HDMI port if necessary.",
    "why is the video lagging": "Video lag may be caused by a slow computer, unstable internet connection, or incorrect encoder settings. Try lowering the video resolution, closing other programs running in the background, and checking your upload speed.",
    "how to check internet connection": "You can check your internet connection by visiting a speed test website like speedtest.net. Make sure the upload speed is stable and above 5 Mbps for smooth streaming. If the connection is unstable, try restarting the modem/router.",
    "how to reduce audio feedback": "To reduce or eliminate audio feedback, ensure that microphones are not too close to speakers. Lower the volume of speakers or use headphones. Avoid pointing microphones directly at speakers.",
    "computer not detecting audio device": "Check if the audio device is properly plugged in. Go to your system's audio settings and make sure the correct input/output device is selected. Restart your computer or update the audio driver if needed.",
    "stream keeps disconnecting": "This is often caused by poor internet connectivity. Make sure you are using a wired connection if possible. Check your encoder settings and ensure the bitrate is appropriate for your upload speed.",
    "OBS is not capturing video": "Make sure the correct video source is selected in OBS. Check camera permissions on your computer. Restart OBS and try adding the source again. If youâ€™re using a capture card, verify it's properly connected and recognized.",
    "microphone volume is too low": "Check your audio mixer levels and make sure the gain is set properly. Also, go to your system's sound settings and increase the input volume for the microphone.",
    "audio and video are not in sync": "This could be due to encoding delay. Try enabling audio delay settings in your streaming software (e.g., OBS) to match the video. Also check that all devices are properly synced and avoid using wireless audio sources if possible.",
    "why is computer running slow": "Your computer may be running slow due to too many background programs, low disk space, or malware. Try closing unnecessary applications, running a disk cleanup, restarting the system, or scanning for viruses.",
    "computer wonâ€™t turn on": "Check if the power cable is properly connected. If using a laptop, ensure the battery is charged. Try pressing and holding the power button for 10 seconds. If there's no response, it may be a hardware issue.",
    "why is screen black after turning on": "This may be caused by a loose display cable, faulty graphics card, or corrupted startup. Try restarting the computer and checking all cables. If using a monitor, ensure itâ€™s turned on and set to the correct input source.",
    "black screen": "This may be caused by a loose display cable, faulty graphics card, or corrupted startup. Try restarting the computer and checking all cables. If using a monitor, ensure itâ€™s turned on and set to the correct input source.",
    "why is computer overheating": "Overheating may be due to dust buildup, blocked air vents, or overuse. Clean the fans, keep the computer in a well-ventilated area, and avoid running heavy programs for long periods without cooling.",
    "why is keyboard not working": "Make sure itâ€™s properly connected. If wireless, check the batteries. Restart your computer or try another USB port. If still not working, test with another keyboard to determine if itâ€™s a hardware issue.",
    "computer freezes or crashes": "Frequent freezing may be due to insufficient RAM, corrupted files, overheating, or software conflicts. Try restarting the computer, updating software, and checking for malware or driver updates.",
    "canâ€™t connect to wifi": "Check if Wi-Fi is enabled on your device. Restart your router and computer. Make sure you're entering the correct password and that the router isn't out of range. You can also try 'Forget Network' and reconnect.",
    "why is mouse not responding": "Ensure the mouse is properly connected. If itâ€™s wireless, check or replace the battery. Try connecting to another USB port or testing with another device to rule out a faulty mouse.",
    "how to fix blue screen error": "A blue screen (BSOD) often indicates a critical system error. Note the error code shown. Restart your computer and ensure all drivers are up to date. If it repeats, run a system scan or check for faulty hardware.",
    "how to remove virus from computer": "Install or update your antivirus software and run a full system scan. Quarantine or remove detected threats. Avoid downloading from unknown websites and regularly update your system for security patches.",
    "my computer wonâ€™t boot to windows": "Try restarting and pressing F8 or Shift+F8 to access Safe Mode. If it works, troubleshoot from there. You may also use a Windows installation USB or recovery disk to repair startup issues.",
    "why is my computer making loud noises": "Loud noises usually come from fans or hard drives. Clean dust from the fans and ensure they are not blocked. If the noise persists, it may indicate a failing fan or mechanical hard drive issue.",
    "need more help": "If you're still experiencing issues, feel free to reach out to the TSV Group Chat for direct assistance. A fellow TSV member will guide you through troubleshooting steps or escalate the problem if needed.",
    "help": "If you're experiencing problem? Feel free to reach out to the TSV Group Chat for direct assistance. A fellow TSV member will guide you through troubleshooting steps or escalate the problem if needed."
  };

  function chat() {
    const input = document.getElementById("userInput").value.trim().toLowerCase();
    if (!input) return;

    appendMessage("You", input, "user");
    document.getElementById("userInput").value = "";

    const typingDiv = document.createElement("div");
    typingDiv.className = "msg bot";
    typingDiv.id = "typingIndicator";
    typingDiv.innerHTML = `<strong>TSV Bot:</strong> <em>typing...</em>`;
    document.getElementById("chatbox").appendChild(typingDiv);
    document.getElementById("chatbox").scrollTop = document.getElementById("chatbox").scrollHeight;

    setTimeout(() => {
      const response = getBotReply(input);
      const typing = document.getElementById("typingIndicator");
      if (typing) typing.remove();
      appendMessage("TSV Bot", response, "bot");
    }, 1200);
  }

  function getBotReply(input) {
    for (const key in botResponses) {
      if (input.includes(key)) {
        return botResponses[key];
      }
    }
    return "I'm sorry, I don't have an answer to that. Please ask about TSV related only.";
  }

  function appendMessage(sender, text, cls) {
    const chatbox = document.getElementById("chatbox");
    const div = document.createElement("div");
    div.className = `msg ${cls}`;
    div.innerHTML = `<strong>${sender}:</strong> <span id="typingText"></span>`;
    chatbox.appendChild(div);
    chatbox.scrollTop = chatbox.scrollHeight;

    let i = 0;
    const typingSpan = div.querySelector("#typingText");
    const typingInterval = setInterval(() => {
      if (i < text.length) {
        typingSpan.innerHTML += text.charAt(i);
        i++;
        chatbox.scrollTop = chatbox.scrollHeight;
      } else {
        clearInterval(typingInterval);
      }
    }, 30);
  }

  document.getElementById("userInput").addEventListener("keypress", function(e) {
    if (e.key === "Enter") chat();
  });
</script>

<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
  import { getFirestore, doc, getDoc, collection, addDoc, query, where, getDocs, orderBy, serverTimestamp, onSnapshot, updateDoc } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";
  import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";
  import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-storage.js";

  const firebaseConfig = { Â  Â  
    apiKey: "AIzaSyAwzp3h8tt_tcDF1um--LoroAu1rErMmBc",
    authDomain: "virac-tsv.firebaseapp.com",
    projectId: "virac-tsv",
    storageBucket: "virac-tsv.appspot.com",
    messagingSenderId: "455316064834",
    appId: "1:455316064834:web:1dc1033265b58a6c82bbdb"
  };

  
  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const auth = getAuth(app);
  const storage = getStorage(app);

  const myFullNameEl = document.getElementById('myFullName');
  const myScheduleTextEl = document.getElementById('myScheduleText');
  const myScheduleDateTimeTextEl = document.getElementById('myScheduleDateTimeText');
  const btnTimeIn = document.getElementById('btnTimeIn');
  const btnTimeOut = document.getElementById('btnTimeOut');
  const attendanceTbody = document.getElementById('attendanceTbody');
  const announcementsList = document.getElementById('announcementsList');
  const fileInput = document.getElementById('fileInput');
  const btnUploadExcuse = document.getElementById('btnUploadExcuse');
  const uploadStatus = document.getElementById('uploadStatus');
  const btnLogout = document.getElementById('btnLogout');
  const alertContainer = document.getElementById('alertContainer');
  const excuseReason = document.getElementById('excuseReason');

  function showAlert(msg,type='success',timeout=3500){
    const el=document.createElement('div');el.className=`alert alert-${type}`;el.textContent=msg;
    alertContainer.appendChild(el);setTimeout(()=>el.remove(),timeout);
  }

  const dayNameToWeekday = { "Linggo":0,"Lunes":1,"Martes":2,"Miyerkules":3,"Huwebes":4,"Biyernes":5,"Sabado":6 };

  function computeNextScheduleDateTime(scheduleText){
    if(!scheduleText)return null;
    const parts=scheduleText.trim().split(/\s+/);
    const weekday=dayNameToWeekday[parts[0]];
    if(weekday===undefined)return null;
    let hour=6,minute=0,ampm="AM";
    const m=parts[1]?.match(/(\d{1,2})(?::(\d{2}))?\s*(AM|PM)?/i);
    if(m){hour=parseInt(m[1]);minute=m[2]?parseInt(m[2]):0;ampm=m[3]?m[3].toUpperCase():"AM";}
    if(ampm==="PM"&&hour<12)hour+=12;if(ampm==="AM"&&hour===12)hour=0;
    const now=new Date();let daysUntil=(weekday-now.getDay()+7)%7;
    const candidate=new Date(now);candidate.setDate(now.getDate()+daysUntil);
    candidate.setHours(hour,minute,0,0);
    return candidate;
  }

  function isScheduleToday(schedule){
    const now=new Date();
    const schedDate=(typeof schedule==='string'&&schedule.includes('T'))?new Date(schedule):computeNextScheduleDateTime(schedule);
    return schedDate && schedDate.toDateString()===now.toDateString();
  }

  function isWithinTwoHoursBefore(schedule){
    const sched=(typeof schedule==='string'&&schedule.includes('T'))?new Date(schedule):computeNextScheduleDateTime(schedule);
    const diffHours=(sched-new Date())/(1000*60*60);
    return diffHours<=2 && diffHours>=0;
  }

  async function resetAttendanceWeekly(uid){
    const userRef=doc(db,'users',uid);
    const snap=await getDoc(userRef);
    const data=snap.data();
    const today=new Date();
    if(today.getDay()===1 && data.lastReset!==today.toDateString()){
      await updateDoc(userRef,{timeIn:null,timeOut:null,lastReset:today.toDateString()});
    }
  }

  async function loadAttendanceHistory(uid){
    attendanceTbody.innerHTML='<tr><td colspan="3" class="text-center muted">Loading...</td></tr>';
    const q=query(collection(db,'attendance'),where('userId','==',uid),orderBy('timestamp','desc'));
    const snap=await getDocs(q);
    attendanceTbody.innerHTML='';
    if(snap.empty){attendanceTbody.innerHTML='<tr><td colspan="3" class="text-center muted">No records yet.</td></tr>';return;}
    snap.forEach(docSnap=>{
      const d=docSnap.data();
      const timeText=d.timestamp?.toDate?d.timestamp.toDate().toLocaleString():'';
      attendanceTbody.innerHTML+=`<tr><td>${d.date||''}</td><td>${d.action}</td><td>${timeText}</td></tr>`;
    });
  }

  async function doTimeIn(uid){
    btnTimeIn.disabled=true;
    await addDoc(collection(db,'attendance'),{userId:uid,action:'timeIn',date:new Date().toLocaleDateString(),timestamp:serverTimestamp()});
    await updateDoc(doc(db,'users',uid),{timeIn:new Date().toISOString(),statusAttendance:'Present'});
    loadAttendanceHistory(uid);btnTimeOut.disabled=false;showAlert('Pagtanggap recorded');
  }

  async function doTimeOut(uid){
    btnTimeOut.disabled=true;
    await addDoc(collection(db,'attendance'),{userId:uid,action:'timeOut',date:new Date().toLocaleDateString(),timestamp:serverTimestamp()});
    await updateDoc(doc(db,'users',uid),{timeOut:new Date().toISOString()});
    loadAttendanceHistory(uid);showAlert('Time Out recorded');
  }

  async function uploadExcuse(uid,file,reason){
    if(!file){showAlert('Please choose a file','warning');return;}
    uploadStatus.textContent='Uploading...';
    const ext=file.name.split('.').pop();
    const path=`excuse_letters/${uid}/${Date.now()}.${ext}`;
    const snap=await uploadBytes(ref(storage,path),file);
    const url=await getDownloadURL(snap.ref);
    await addDoc(collection(db,'excuse_letters'),{userId:uid,fileName:file.name,url,reason:reason||'',uploadedAt:serverTimestamp()});
    uploadStatus.textContent='Upload successful.';fileInput.value='';excuseReason.value='';
    setTimeout(()=>uploadStatus.textContent='',3000);
  }

  onAuthStateChanged(auth, async (user)=>{
    if(!user){window.location.href='login.html';return;}
    await resetAttendanceWeekly(user.uid);
    const userRef=doc(db,'users',user.uid);
    const snap=await getDoc(userRef);
    if(!snap.exists()){showAlert('User not found','danger');return;}
    const data=snap.data();
    myFullNameEl.textContent=data.fullName||user.email;
    myScheduleTextEl.textContent='Schedule: '+(data.schedule||'No schedule');
    const scheduleDisplay=(data.scheduleDateTime)?new Date(data.scheduleDateTime):computeNextScheduleDateTime(data.schedule);
    myScheduleDateTimeTextEl.textContent=scheduleDisplay?`(${scheduleDisplay.toLocaleString()})`:'';
    btnTimeIn.style.display=(isScheduleToday(data.schedule||data.scheduleDateTime)&&data.status==='admitted')?'inline-block':'none';
    btnTimeOut.style.display=isWithinTwoHoursBefore(data.schedule||data.scheduleDateTime)?'inline-block':'none';
    if(data.timeIn){btnTimeIn.disabled=true;btnTimeOut.disabled=false;}
    await loadAttendanceHistory(user.uid);
    onSnapshot(collection(db,'announcements'),orderBy('date','desc'),snap=>{
      announcementsList.innerHTML='';if(snap.empty){announcementsList.innerHTML='<li>No announcements.</li>';return;}
      snap.forEach(d=>{const a=d.data();announcementsList.innerHTML+=`<li><strong>${a.title}</strong><div>${a.content}</div></li>`;});
    });
  });

   // âœ… Protect Chatbot page
  onAuthStateChanged(auth, async (user) => {
    if (!user) {
      window.location.href = "login.html";
      return;
    }

    const userRef = doc(db, "users", user.uid);
    const snap = await getDoc(userRef);

    if (!snap.exists() || snap.data().status !== "admitted") {
      alert("Access denied. You must be admitted to use this page.");
      window.location.href = "login.html";
    }
  });
  btnTimeIn.onclick=()=>currentUser&&confirm('Confirm Pagtanggap?')&&doTimeIn(currentUser.uid);
  btnTimeOut.onclick=()=>currentUser&&confirm('Confirm Time Out?')&&doTimeOut(currentUser.uid);
  btnUploadExcuse.onclick=()=>currentUser&&uploadExcuse(currentUser.uid,fileInput.files[0],excuseReason.value.trim());
  btnLogout.onclick=()=>signOut(auth).then(()=>window.location.href='login.html');

  let currentUser=auth.currentUser;

   window.botpressWebChat.init({
      composerPlaceholder: "Type your message...",
      botName: "TSV Assistant",
      botAvatarUrl: "https://upload.wikimedia.org/wikipedia/commons/thumb/4/49/Philippine_Christian_University_logo.png/600px-Philippine_Christian_University_logo.png", // Replace with TSV logo
      enableTranscriptDownload: false,
      theme: "dark",
      themeColor: "#f97316", // Orange highlight
      stylesheet: `
        .bpw-header {
          background-color: #111827 !important;
          border-bottom: 2px solid #f97316 !important;
        }
        .bpw-composer {
          background-color: #1f2937 !important;
          border-top: 2px solid #f97316 !important;
        }
        .bpw-from-bot .bpw-message-bubble {
          background-color: #f97316 !important;
          color: #fff !important;
        }
        .bpw-from-user .bpw-message-bubble {
          background-color: #374151 !important;
          color: #fff !important;
        }
        .bpw-floating-button {
          background-color: #f97316 !important;
        }
      `
    });

    // Open the chat window and send greeting when loaded
    window.addEventListener("load", () => {
      window.botpressWebChat.sendEvent({ type: "show" });

      // Small delay so widget loads before greeting
      setTimeout(() => {
        window.botpressWebChat.sendPayload({
          type: "text",
          text: "Hi! Iâ€™m TSV Assistant ðŸ‘‹ How can I help you today?"
        });
      }, 800);
    });
</script>

</body>
</html>

