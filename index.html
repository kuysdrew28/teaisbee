<!DOCTYPE html>
<html lang="en">
<head>
    <!-- Prevent Google and other bots from indexing -->
  <meta name="robots" content="noindex, nofollow">
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Tech 404 - Official Digital Hub</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <!-- Botpress Inject Scripts -->
<script src="https://cdn.botpress.cloud/webchat/v3.2/inject.js"></script>
<script src="https://files.bpcontent.cloud/2025/08/22/06/20250822063030-NCUYH9BC.js" defer></script>

<!-- Link your custom JS file -->
<script src="javascript/chatbot.js"></script>
  <link rel="stylesheet" href="css/main.css">
    <link rel="stylesheet" href="css/index.css">
      <script src="javascript/footer.js" defer></script>

  <script type="module">
    
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
    import { getFirestore, doc, getDoc, collection, addDoc, query, where, getDocs, orderBy, serverTimestamp, onSnapshot, updateDoc } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";
    import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-storage.js";

    const firebaseConfig = { Â  Â  
        apiKey: "AIzaSyAwzp3h8tt_tcDF1um--LoroAu1rErMmBc",
        authDomain: "virac-tsv.firebaseapp.com",
        projectId: "virac-tsv",
        storageBucket: "virac-tsv.appspot.com",
        messagingSenderId: "455316064834",
        appId: "1:455316064834:web:1dc1033265b58a6c82bbdb"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);
    const storage = getStorage(app);

    const myFullNameEl = document.getElementById('myFullName');
    const myScheduleTextEl = document.getElementById('myScheduleText');
    const myScheduleDateTimeTextEl = document.getElementById('myScheduleDateTimeText');
    const btnTimeIn = document.getElementById('btnTimeIn');
    const btnTimeOut = document.getElementById('btnTimeOut');
    const attendanceTbody = document.getElementById('attendanceTbody');
    const announcementsList = document.getElementById('announcementsList');
    const fileInput = document.getElementById('fileInput');
    const btnUploadExcuse = document.getElementById('btnUploadExcuse');
    const uploadStatus = document.getElementById('uploadStatus');
    const btnLogout = document.getElementById('btnLogout');
    const alertContainer = document.getElementById('alertContainer');
    const excuseReason = document.getElementById('excuseReason');

    function showAlert(msg, type = 'success', timeout = 3500) {
      const el = document.createElement('div');
      el.className = `alert alert-${type} animated fadeInDown`;
      el.textContent = msg;
      alertContainer.appendChild(el);
      setTimeout(() => {
        el.classList.remove('fadeInDown');
        el.classList.add('fadeOutUp');
        setTimeout(() => el.remove(), 500);
      }, timeout);
    }

    const dayNameToWeekday = { "Linggo": 0, "Lunes": 1, "Martes": 2, "Miyerkules": 3, "Huwebes": 4, "Biyernes": 5, "Sabado": 6 };

    function computeNextScheduleDateTime(scheduleText) {
      if (!scheduleText) return null;
      const parts = scheduleText.trim().split(/\s+/);
      const weekday = dayNameToWeekday[parts[0]];
      if (weekday === undefined) return null;
      let hour = 6, minute = 0, ampm = "AM";
      const m = parts[1]?.match(/(\d{1,2})(?::(\d{2}))?\s*(AM|PM)?/i);
      if (m) { hour = parseInt(m[1]); minute = m[2] ? parseInt(m[2]) : 0; ampm = m[3] ? m[3].toUpperCase() : "AM"; }
      if (ampm === "PM" && hour < 12) hour += 12;
      if (ampm === "AM" && hour === 12) hour = 0;
      const now = new Date();
      let daysUntil = (weekday - now.getDay() + 7) % 7;
      const candidate = new Date(now);
      candidate.setDate(now.getDate() + daysUntil);
      candidate.setHours(hour, minute, 0, 0);
      return candidate;
    }

    function isScheduleToday(schedule) {
      const now = new Date();
      const schedDate = (typeof schedule === 'string' && schedule.includes('T')) ? new Date(schedule) : computeNextScheduleDateTime(schedule);
      return schedDate && schedDate.toDateString() === now.toDateString();
    }

    function isWithinTwoHoursBefore(schedule) {
      const sched = (typeof schedule === 'string' && schedule.includes('T')) ? new Date(schedule) : computeNextScheduleDateTime(schedule);
      const diffHours = (sched - new Date()) / (1000 * 60 * 60);
      return diffHours <= 2 && diffHours >= 0;
    }

    async function resetAttendanceWeekly(uid) {
      const userRef = doc(db, 'users', uid);
      const snap = await getDoc(userRef);
      const data = snap.data();
      const today = new Date();
      if (today.getDay() === 1 && data.lastReset !== today.toDateString()) {
        await updateDoc(userRef, { timeIn: null, timeOut: null, lastReset: today.toDateString() });
      }
    }

    async function loadAttendanceHistory(uid) {
      attendanceTbody.innerHTML = '<tr><td colspan="3" class="text-center text-muted">Loading...</td></tr>';
      const q = query(collection(db, 'attendance'), where('userId', '==', uid), orderBy('timestamp', 'desc'));
      const snap = await getDocs(q);
      attendanceTbody.innerHTML = '';
      if (snap.empty) { attendanceTbody.innerHTML = '<tr><td colspan="3" class="text-center text-muted">No records yet.</td></tr>'; return; }
      snap.forEach(docSnap => {
        const d = docSnap.data();
        const timeText = d.timestamp?.toDate ? d.timestamp.toDate().toLocaleString() : '';
        attendanceTbody.innerHTML += `<tr><td>${d.date || ''}</td><td>${d.action}</td><td>${timeText}</td></tr>`;
      });
    }

    async function doTimeIn(uid) {
      btnTimeIn.disabled = true;
      await addDoc(collection(db, 'attendance'), { userId: uid, action: 'timeIn', date: new Date().toLocaleDateString(), timestamp: serverTimestamp() });
      await updateDoc(doc(db, 'users', uid), { timeIn: new Date().toISOString(), statusAttendance: 'Present' });
      loadAttendanceHistory(uid);
      btnTimeOut.disabled = false;
      showAlert('Pagtanggap recorded');
    }

    async function doTimeOut(uid) {
      btnTimeOut.disabled = true;
      await addDoc(collection(db, 'attendance'), { userId: uid, action: 'timeOut', date: new Date().toLocaleDateString(), timestamp: serverTimestamp() });
      await updateDoc(doc(db, 'users', uid), { timeOut: new Date().toISOString() });
      loadAttendanceHistory(uid);
      showAlert('Time Out recorded');
    }

    async function uploadExcuse(uid, file, reason) {
      if (!file) { showAlert('Please choose a file', 'warning'); return; }
      uploadStatus.textContent = 'Uploading...';
      const ext = file.name.split('.').pop();
      const path = `excuse_letters/${uid}/${Date.now()}.${ext}`;
      const snap = await uploadBytes(ref(storage, path), file);
      const url = await getDownloadURL(snap.ref);
      await addDoc(collection(db, 'excuse_letters'), { userId: uid, fileName: file.name, url, reason: reason || '', uploadedAt: serverTimestamp() });
      uploadStatus.textContent = 'Upload successful.';
      fileInput.value = '';
      excuseReason.value = '';
      setTimeout(() => uploadStatus.textContent = '', 3000);
    }

onAuthStateChanged(auth, async (user) => {
  if (!user) {
    window.location.href = 'login.html';
    return;
  }

  await resetAttendanceWeekly(user.uid);
  const userRef = doc(db, 'users', user.uid);
  const snap = await getDoc(userRef);

  if (!snap.exists()) {
    showAlert('User not found', 'danger');
    return;
  }

  const data = snap.data();

  // ðŸš« If user is not admitted, redirect to denied.html
  if (data.status !== 'admitted') {
    window.location.href = 'denied.html';
    return;
  }

  myFullNameEl.textContent = data.fullName || user.email;
  myScheduleTextEl.textContent = 'Schedule: ' + (data.schedule || 'No schedule');

  const scheduleDisplay = (data.scheduleDateTime)
    ? new Date(data.scheduleDateTime)
    : computeNextScheduleDateTime(data.schedule);

  myScheduleDateTimeTextEl.textContent = scheduleDisplay
    ? `(${scheduleDisplay.toLocaleString()})`
    : '';

  btnTimeIn.style.display = isScheduleToday(data.schedule || data.scheduleDateTime)
    ? 'inline-block'
    : 'none';

  btnTimeOut.style.display = isWithinTwoHoursBefore(data.schedule || data.scheduleDateTime)
    ? 'inline-block'
    : 'none';

  if (data.timeIn) {
    btnTimeIn.disabled = true;
    btnTimeOut.disabled = false;
  }

  await loadAttendanceHistory(user.uid);

  onSnapshot(
    collection(db, 'announcements'),
    orderBy('date', 'desc'),
    snap => {
      announcementsList.innerHTML = '';
      if (snap.empty) {
        announcementsList.innerHTML = '<li class="list-group-item text-center text-muted">No announcements.</li>';
        return;
      }
      snap.forEach(d => {
        const a = d.data();
        announcementsList.innerHTML += `
          <a href="#" class="announcement-item">
            <div class="announcement-icon"><i class="fa-solid fa-calendar-check"></i></div>
            <div class="announcement-content">
              <h5>${a.title}</h5>
              <p>${a.content}</p>
              <small>Posted on ${a.date}</small>
            </div>
          </a>`;
      });
    }
  );
});


    let currentUser = auth.currentUser;
    btnTimeIn.onclick = () => currentUser && confirm('Confirm Pagtanggap?') && doTimeIn(currentUser.uid);
    btnTimeOut.onclick = () => currentUser && confirm('Confirm Pagtupad?') && doTimeOut(currentUser.uid);
    btnUploadExcuse.onclick = () => currentUser && uploadExcuse(currentUser.uid, fileInput.files[0], excuseReason.value.trim());
    btnLogout.onclick = () => signOut(auth).then(() => window.location.href = 'login.html');

      fetch("footer.html")
    .then(response => response.text())
    .then(data => {
      document.getElementById("footer").innerHTML = data;
    });
  </script>
</head>
<body>

<nav class="navbar navbar-expand-lg sticky-top">
  <div class="container">
    <a class="navbar-brand" href="index.html">
      <img src="image/tsv_logo.png" alt="TSV Virac Logo" height="60" />
    </a>
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navMenu" aria-controls="navMenu" aria-expanded="false" aria-label="Toggle navigation">
      <i class="fa-solid fa-bars text-white"></i>
    </button>
    <div class="collapse navbar-collapse" id="navMenu">
      <ul class="navbar-nav ms-auto mb-2 mb-lg-0">
        <li class="nav-item"><a class="nav-link active" aria-current="page" href="index.html">Home</a></li>
        <li class="nav-item"><a class="nav-link" href="tsvsuguan-auto.html">Suguan</a></li>
                        <li class="nav-item"><a class="nav-link" href="tsvgames.html">TSV Games (BETA)</a></li>
        <li class="nav-item"><a class="nav-link" href="member-panel.html">User Panel</a></li>
                            <li class="nav-item"><a class="nav-link active" href="inventory-report.html">Inventory</a></li>
                <li class="nav-item"><a class="nav-link" href="admin-panel.html">Administrator</a></li>
      </ul>
    </div>
  </div>
</nav>

<section class="hero">
  <video autoplay muted loop playsinline class="hero-video">
    <source src="video/cover.mp4" type="video/mp4" />
    Your browser does not support the video tag.
  </video>
  <div class="hero-overlay"></div>
  <div class="hero-content">
    <h1 class="display-3">Welcome</h1>
    <p class="lead mt-4">The official digital hub, your source for activities, announcements, and updates.</p>
    <a href="#about-section" class="btn hero-button">Explore More <i class="fa-solid fa-arrow-down ms-2"></i></a>
  </div>
</section>

<section id="about-section" class="py-5 bg-white">
  <div class="container">
    <h2 class="section-title text-center">About Us</h2>
    <div class="row g-4">
      <div class="col-md-4">
        <div class="about-icon-box">
          <i class="fa-solid fa-calendar-alt"></i>
          <h5 class="mt-3">Schedule of Duties</h5>
          <p class="text-muted">Stay informed and organized â€” hereâ€™s your official schedule of duties</p>
        </div>
      </div>
      <div class="col-md-4">
        <div class="about-icon-box">
          <i class="fa-solid fa-bullhorn"></i>
          <h5 class="mt-3">Announcements</h5>
          <p class="text-muted">Keeping TSV officers informed with the latest updates and announcements.</p>
        </div>
      </div>
      <div class="col-md-4">
        <div class="about-icon-box">
          <i class="fa-solid fa-robot"></i>
          <h5 class="mt-3">AI Support</h5>
          <p class="text-muted">Providing reliable technical assistance for streaming and technical needs.</p>
        </div>
      </div>
    </div>
  </div>
</section>

---

<section id="activities-section" class="py-5">
  <div class="container">
    <h2 class="section-title text-center">Activities</h2>
    <div class="row g-4 justify-content-center">
      <div class="col-md-6 col-lg-5">
        <div class="activity-card">
          <img src="image/TSVAct2.jpg" alt="TSV Talk and Workshop" class="img-fluid" />
          <div class="activity-card-body">
            <h5 class="card-title">TSV Talk and Workshop</h5>
            <p class="card-text">The TSV Talk and Workshop in Legazpi City, Albay, was attended by TSV officers from the Ecclesiastical District of Catanduanes. This activity enhanced their technical knowledge, particularly in cable management, which is vital for maintaining equipment functionality and longevity.</p>
          </div>
        </div>
      </div>

      <div class="col-md-6 col-lg-5">
        <div class="activity-card">
          <img src="image/TSVAct1.jpg" alt="Catanduanes 3rd Place" class="img-fluid" />
          <div class="activity-card-body">
            <h5 class="card-title">Catanduanes Takes 3rd Place</h5>
            <p class="card-text">The District of Catanduanes earned 3rd Place Overall in the workshop activities. This achievement reflects the dedication and competence of the Catanduanes TSV officers, serving as a strong motivation for them to continue performing their duties with enthusiasm.</p>
          </div>
        </div>
      </div>
    </div>
  </div>
</section>

---

<section id="announcements-section" class="py-5 bg-white">
  <div class="container">
    <h2 class="section-title text-center">Announcements</h2>
    <div class="row justify-content-center">
      <div class="col-lg-8">
        <div id="announcementsList">
         <a href="#" class="announcement-item">
            <div class="announcement-icon"><i class="fa-solid fa-calendar-check"></i></div>
            <div class="announcement-content">
              <h5>TSV Games (BETA) Released</h5>
              <p>We invite you to explore the latest feature of the Virac TSV website â€” TSV Games (Beta Version), an innovative way of learning through play. In these games, you will learn how to perform computer troubleshooting, the appropriate steps to resolve technical issues, and you will also become familiar with the different software and hardware components that are essential in the field of technology.</p>
              <small>Posted on August 28, 2025</small>
            </div>
          </a>
          
          <a href="#" class="announcement-item">
            <div class="announcement-icon"><i class="fa-solid fa-calendar-check"></i></div>
            <div class="announcement-content">
              <h5>TSV Get Together - September 28, 2025 (Tentative)</h5>
              <p>All TSV Virac members are required to attend our Anniversary Celebration at ARDCI SkyDeck.</p>
              <small>Posted on August 24, 2025</small>
            </div>
          </a>
          <a href="#" class="announcement-item">
            <div class="announcement-icon"><i class="fa-solid fa-wrench"></i></div>
            <div class="announcement-content">
              <h5>TSV Management System Deployment - Version 2</h5>
              <p>We are pleased to announce the official deployment of Version 2 of the TSV Website on August 24, 2025. This upgrade introduces significant improvements designed to enhance your overall experience, streamline processes, and strengthen system security.</p>
              <small>Posted on August 18, 2025</small>
            </div>
          </a>

        </div>
      </div>
    </div>
  </div>
</section>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
