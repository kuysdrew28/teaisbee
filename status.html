<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>TSV Dashboard</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <style>
        :root {
      --primary-orange: #ff7e29;
      --secondary-orange: #ff9e4d;
      --dark-gray: #1a1a1a;
      --light-gray: #f5f5f5;
      --bg-dark: #121212;
      --text-light: #e0e0e0;
      --card-bg: #1e1e1e;
      --transition-ease: 0.3s ease;
    }
    body { background: #0f172a; color: #e2e8f0; }
    .card { background: #111827; border: 1px solid #1f2937; }
    .form-control, .form-select { background: #0b1220; color: #e5e7eb; border-color: #1f2937; }
    .form-control:focus, .form-select:focus { background: #0b1220; color: #fff; border-color: #3b82f6; box-shadow: 0 0 0 .2rem rgba(59,130,246,.25); }
    .table { color: #e5e7eb; }
    .table thead th { color: #93c5fd; border-bottom-color: #374151; }
    .table tbody tr { border-color: #1f2937; }
    .badge-present { background: #16a34a; }
    .badge-absent { background: #dc2626; }
    .badge-unknown { background: #6b7280; }
    .small-muted { color:#94a3b8; font-size:.9rem; }
    .display-6 {
  color: #dfdddd !important; /* force white text */
  font-weight: bold;
}
    #weekTitle {
  color: #dfdddd !important; /* force white text */
  font-weight: bold;
}
    .link-lightish { color:#93c5fd; text-decoration:none; }
    .link-lightish:hover { text-decoration:underline; }
    .sticky-top-bar { position: sticky; top: 0; z-index: 1030; background: linear-gradient(180deg, rgba(15,23,42,.98), rgba(15,23,42,.85)); backdrop-filter: blur(4px); border-bottom: 1px solid #1f2937; }
     .navbar {
      background: var(--dark-gray);
      border-bottom: 3px solid var(--primary-orange);
      transition: var(--transition-ease);
    }
    .navbar-brand img {
      filter: drop-shadow(0 0 8px var(--primary-orange));
    }
    .nav-link {
      color: var(--text-light) !important;
      font-weight: 500;
      transition: var(--transition-ease);
      padding: 0.5rem 1rem !important;
      position: relative;
    }
    .nav-link::after {
      content: '';
      position: absolute;
      bottom: 0;
      left: 50%;
      width: 0;
      height: 2px;
      background-color: var(--primary-orange);
      transition: var(--transition-ease);
      transform: translateX(-50%);
    }
    .nav-link:hover::after, .nav-link.active::after {
      width: 80%;
    }
    .nav-link:hover, .nav-link.active {
      color: var(--primary-orange) !important;
    }
    
      .button-container {
      text-align: center;
      margin: 20px 0;
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 10px;
    }
    
    .action-button, .action-button-active {
      display: inline-block;
      padding: 10px 20px;
      background-color: var(--secondary-orange);
      color: var(--dark-gray);
      font-weight: bold;
      border: none;
      border-radius: 6px;
      text-decoration: none;
      transition: background-color 0.3s;
    }
    .action-button:hover, .action-button-active:hover {
      background-color: var(--primary-orange);
    }
    .action-button-active {
      background-color: var(--primary-orange);
      color: var(--dark-gray);
    }

    .controls-container {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 40px;
      align-items: center;
      padding: 20px 0;
    }
    .controls-container label {
      color: var(--text-light);
    }
    .controls-container select, .controls-container button {
      padding: 10px;
      font-size: 16px;
      width: 200px;
      background-color: var(--dark-gray);
      color: var(--text-light);
      border: 1px solid var(--primary-orange);
      border-radius: 6px;
    }
    .controls-container select:focus, .controls-container button:focus {
      outline: none;
      box-shadow: 0 0 5px var(--primary-orange);
    }
    .controls-container button {
      width: auto;
      background-color: var(--primary-orange);
      color: var(--dark-gray);
      font-weight: bold;
    }
    .controls-container button:hover {
      background-color: var(--secondary-orange);
    }

   footer {
      background-color: var(--dark-gray);
      color: var(--text-light);
      padding: 40px 0;
      margin-top: auto;
      text-align: center;
    }
    footer img {
      width: 160px;
      margin-bottom: 10px;
      filter: drop-shadow(0 0 8px var(--primary-orange));
    }
    footer p {
      color: var(--text-light);
      margin: 0;
    }
    .footer-links {
      margin-top: 10px;
    }
    .footer-links a {
      color: var(--primary-orange);
      text-decoration: none;
      margin: 0 10px;
      transition: color 0.3s ease;
    }
    .footer-links a:hover {
      color: var(--secondary-orange);
    }
  </style>
</head>
<body>
      <nav class="navbar navbar-expand-lg sticky-top">
    <div class="container">
      <a class="navbar-brand" href="index.html">
        <img src="image/tsv_logo.png" alt="TSV Virac Logo" height="60" />
      </a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navMenu" aria-controls="navMenu" aria-expanded="false" aria-label="Toggle navigation">
        <i class="fa-solid fa-bars text-white"></i>
      </button>
      <div class="collapse navbar-collapse" id="navMenu">
        <ul class="navbar-nav ms-auto mb-2 mb-lg-0">
          <li class="nav-item"><a class="nav-link" href="home.html">Home</a></li>
          <li class="nav-item"><a class="nav-link" href="index.html">Suguan</a></li>
          <li class="nav-item"><a class="nav-link" href="chatbot.html">Chat Bot</a></li>
          <li class="nav-item"><a class="nav-link" href="announcement.html">Announcement</a></li>
          <li class="nav-item"><a class="nav-link" href="activities.html">Activities</a></li>
          <li class="nav-item"><a class="nav-link" href="user.html">My Schedule</a></li>
          <li class="nav-item"><a class="nav-link active" aria-current="page" href="login1.html">Admin</a></li>
        </ul>
      </div>
    </div>
  </nav>

<div class="container my-5 flex-grow-1">
  <div class="button-container">
    <a href="assign.html" class="action-button">Manage Users</a>
    <a href="status.html" class="action-button-active">TSV Status</a>
    <a href="superadmin.html" class="action-button">Admit TSV</a>
    <a href="survey/admin-survey.html" class="action-button">Schedule</a>
    <a href="TSV Form 3.xlsx" class="action-button">Download TSV Form 3</a>
    <a href="Attendance/admin.html" class="action-button">Attendance</a>
  </div>
  <nav class="sticky-top-bar">
    <div class="container py-3 d-flex flex-wrap align-items-center gap-3">

      <div class="ms-auto d-flex align-items-center gap-2">
        <label for="weekInput" class="form-label m-0 me-1 small-muted">Week No.</label>
        <input id="weekInput" type="number" min="1" max="53" class="form-control form-control-sm" style="width: 90px" />
        <button id="loadBtn" class="btn btn-primary btn-sm">Load wk<span id="loadWeekLabel"></span></button>
        <button id="exportCsvBtn" class="btn btn-outline-light btn-sm">Export CSV</button>
      </div>
    </div>
  </nav>

  <main class="container my-4">
    <div class="row g-3">
      <div class="col-12 col-lg-3">
        <div class="card h-100">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-center">
              <div>
                <div class="small-muted">Week Collection</div>
                <div class="h4 mb-0" id="weekTitle">wk--</div>
              </div>
              <div class="text-end small-muted">
                <div>Asia/Manila</div>
                <div id="nowClock">--:--</div>
              </div>
            </div>
            <div class="mt-3 small-muted">Project: <span class="text-white-50">virac-tsv</span></div>
            <div class="mt-1 small-muted">Live updates: <span class="badge bg-secondary" id="liveBadge">OFF</span></div>
            <div id="statusAlert" class="alert alert-warning mt-3 py-2 px-3 d-none"></div>
          </div>
        </div>
      </div>

      <div class="col-12 col-lg-9">
        <div class="row g-3">
          <div class="col-12 col-sm-4">
            <div class="card">
              <div class="card-body">
                <div class="small-muted">Total TSV Assigned</div>
                <div class="display-6" id="totalCount">0</div>
              </div>
            </div>
          </div>
          <div class="col-12 col-sm-4">
            <div class="card">
              <div class="card-body">
                <div class="small-muted">Present</div>
                <div class="display-6" id="presentCount">0</div>
              </div>
            </div>
          </div>
          <div class="col-12 col-sm-4">
            <div class="card">
              <div class="card-body">
                <div class="small-muted">Absent</div>
                <div class="display-6" id="absentCount">0</div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="col-12 col-lg-6">
        <div class="card h-100">
          <div class="card-header bg-transparent border-0"><span class="small-muted">Present vs Absent</span></div>
          <div class="card-body">
            <canvas id="piePresence" height="220"></canvas>
          </div>
        </div>
      </div>

      <div class="col-12 col-lg-6">
        <div class="card h-100">
          <div class="card-header bg-transparent border-0 d-flex justify-content-between align-items-center">
            <span class="small-muted">Counts by Assigned Time</span>
            <select id="statusFilter" class="form-select form-select-sm" style="width:auto">
              <option value="all" selected>All</option>
              <option value="present">Present only</option>
              <option value="absent">Absent only</option>
            </select>
          </div>
          <div class="card-body">
            <canvas id="barBySchedule" height="220"></canvas>
          </div>
        </div>
      </div>

      <div class="col-12">
        <div class="card">
          <div class="card-header bg-transparent border-0 d-flex flex-wrap gap-2 align-items-center">
            <span class="small-muted">Records</span>
            <input id="searchInput" class="form-control form-control-sm ms-auto" placeholder="Search by name or schedule" style="max-width:300px" />
          </div>
          <div class="card-body">
            <div class="table-responsive">
              <table class="table table-sm align-middle" id="recordsTable">
                <thead>
                  <tr>
                    <th style="width:30%">Name</th>
                    <th style="width:20%">Assigned Time</th>
                    <th style="width:15%">Pagtanggap</th>
                    <th style="width:15%">Pagtupad</th>
                    <th style="width:10%">Absent</th>
                    <th style="width:10%">Status</th>
                  </tr>
                </thead>
                <tbody id="recordsBody"></tbody>
              </table>
            </div>
            <div class="small-muted mt-2" id="tableHint">Loaded 0 records.</div>
          </div>
        </div>
      </div>
    </div>
  </main>
<footer>
  <div class="container text-center">
    <p class="footer-text mb-0">&copy; 2025 KuysDrew Web Development Inc. All rights reserved.</p>
   <a href="privacy.html" class="btn btn-link text-decoration-none">Privacy Policy & Terms of Service</a>
  </div>
</footer>
  <!-- Firebase SDK (Modular v10) -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
    import { getFirestore, collection, onSnapshot, getDocs } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

    // --- Your Firebase config (provided) ---
    const firebaseConfig = {
      apiKey: "AIzaSyAwzp3h8tt_tcDF1um--LoroAu1rErMmBc",
      authDomain: "virac-tsv.firebaseapp.com",
      projectId: "virac-tsv",
      storageBucket: "virac-tsv.appspot.com",
      messagingSenderId: "455316064834",
      appId: "1:455316064834:web:1dc1033265b58a6c82bbdb"
    };

    // Init
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // UI Elements
    const weekTitle = document.getElementById('weekTitle');
    const nowClock = document.getElementById('nowClock');
    const liveBadge = document.getElementById('liveBadge');
    const statusAlert = document.getElementById('statusAlert');

    const totalCountEl = document.getElementById('totalCount');
    const presentCountEl = document.getElementById('presentCount');
    const absentCountEl = document.getElementById('absentCount');

    const recordsBody = document.getElementById('recordsBody');
    const tableHint = document.getElementById('tableHint');
    const searchInput = document.getElementById('searchInput');

    const weekInput = document.getElementById('weekInput');
    const loadBtn = document.getElementById('loadBtn');
    const loadWeekLabel = document.getElementById('loadWeekLabel');
    const exportCsvBtn = document.getElementById('exportCsvBtn');
    const statusFilter = document.getElementById('statusFilter');

    // Clock (Asia/Manila)
    function tickClock(){
      const now = new Date();
      const opts = { hour:'2-digit', minute:'2-digit', second:'2-digit', hour12:true, timeZone:'Asia/Manila' };
      nowClock.textContent = new Intl.DateTimeFormat('en-PH', opts).format(now);
    }
    setInterval(tickClock, 1000); tickClock();

    // Simple ISO week util (Mon-based)
    function getISOWeek(d = new Date()){
      const date = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
      const dayNum = (date.getUTCDay() + 6) % 7; // Mon=0
      date.setUTCDate(date.getUTCDate() - dayNum + 3);
      const firstThursday = new Date(Date.UTC(date.getUTCFullYear(),0,4));
      const diff = (date - firstThursday) / 86400000;
      return 1 + Math.floor(diff / 7);
    }

    // Default week from URL (?week=25) or current ISO week
    const urlParams = new URLSearchParams(location.search);
    let currentWeek = Number(urlParams.get('week')) || getISOWeek();
    weekInput.value = currentWeek;
    loadWeekLabel.textContent = currentWeek;

    // Charts
    let pieChart, barChart;
    function ensureCharts(){
      if (!pieChart){
        const ctx1 = document.getElementById('piePresence').getContext('2d');
        pieChart = new Chart(ctx1, {
          type: 'doughnut',
          data: { labels: ['Present','Absent'], datasets: [{ data: [0,0] }] },
          options: { plugins:{ legend:{ labels:{ color:'#e5e7eb' } } } }
        });
      }
      if (!barChart){
        const ctx2 = document.getElementById('barBySchedule').getContext('2d');
        barChart = new Chart(ctx2, {
          type: 'bar',
          data: { labels: [], datasets: [{ label: 'Count', data: [] }] },
          options: {
            scales: {
              x: { ticks: { color:'#e5e7eb' }, grid: { color:'#1f2937' } },
              y: { ticks: { color:'#e5e7eb' }, grid: { color:'#1f2937' }, beginAtZero:true, precision:0 }
            },
            plugins:{ legend:{ labels:{ color:'#e5e7eb' } } }
          }
        });
      }
    }

    function updateCharts(present, absent, byScheduleMap){
      ensureCharts();
      // Pie
      pieChart.data.datasets[0].data = [present, absent];
      pieChart.update();
      // Bar (sorted by schedule name)
      const labels = Array.from(byScheduleMap.keys()).sort((a,b)=>a.localeCompare(b));
      const values = labels.map(k => byScheduleMap.get(k));
      barChart.data.labels = labels;
      barChart.data.datasets[0].data = values;
      barChart.update();
    }

    // State
    let unsubscribe = null;
    let currentRows = [];

    function asDateStr(ts){
      if (!ts) return '';
      // Firestore Timestamp or string/date
      try{
        const d = ts.toDate ? ts.toDate() : new Date(ts);
        const opts = { dateStyle:'medium', timeStyle:'short', timeZone:'Asia/Manila' };
        return new Intl.DateTimeFormat('en-PH', opts).format(d);
      }catch(e){ return String(ts); }
    }

    function deriveStatus(rec){
      // Logical status rules:
      // Present if timeIn exists and absent !== true
      const hasIn = !!rec.timeIn;
      const isAbsent = rec.absent === true;
      if (isAbsent) return 'absent';
      if (hasIn) return 'present';
      return 'unknown';
    }

    function renderTable(rows){
      recordsBody.innerHTML = '';
      const frag = document.createDocumentFragment();
      let shown = 0;
      for (const r of rows){
        // filter by status
        const f = statusFilter.value;
        if (f !== 'all' && deriveStatus(r) !== f) continue;
        // search filter
        const q = searchInput.value.trim().toLowerCase();
        if (q){
          const hay = `${r.name} ${r.assignedTime || ''}`.toLowerCase();
          if (!hay.includes(q)) continue;
        }
        const tr = document.createElement('tr');
        const status = deriveStatus(r);
        tr.innerHTML = `
          <td>${escapeHtml(r.name)}</td>
          <td>${escapeHtml(r.assignedTime || '')}</td>
          <td>${escapeHtml(asDateStr(r.timeIn))}</td>
          <td>${escapeHtml(asDateStr(r.timeOut))}</td>
          <td>${r.absent === true ? '<span class="badge badge-absent">Yes</span>' : '<span class="badge bg-secondary">No</span>'}</td>
          <td>
            ${status === 'present' ? '<span class="badge badge-present">Present</span>' : status === 'absent' ? '<span class="badge badge-absent">Absent</span>' : '<span class="badge badge-unknown">Unknown</span>'}
          </td>`;
        frag.appendChild(tr);
        shown++;
      }
      recordsBody.appendChild(frag);
      tableHint.textContent = `Loaded ${rows.length} records. Showing ${shown}.`;
    }

    function escapeHtml(s){
      return String(s ?? '').replace(/[&<>'"]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','\'':'&#39;','\"':'&quot;'}[c]));
    }

    function recomputeAndRender(){
      const total = currentRows.length;
      const present = currentRows.filter(r => deriveStatus(r) === 'present').length;
      const absent = currentRows.filter(r => deriveStatus(r) === 'absent').length;
      totalCountEl.textContent = total;
      presentCountEl.textContent = present;
      absentCountEl.textContent = absent;

      const bySchedule = new Map();
      for (const r of currentRows){
        const key = r.assignedTime || '(Unassigned)';
        bySchedule.set(key, (bySchedule.get(key) || 0) + 1);
      }
      updateCharts(present, absent, bySchedule);
      renderTable(currentRows);
    }

    async function loadWeek(weekNo){
      // Cleanup previous subscription
      if (unsubscribe){ unsubscribe(); unsubscribe = null; }
      currentRows = [];
      renderTable(currentRows);
      totalCountEl.textContent = presentCountEl.textContent = absentCountEl.textContent = '0';
      liveBadge.textContent = 'OFF';
      weekTitle.textContent = `wk${weekNo}`;
      statusAlert.classList.add('d-none');

      const collName = `wk${weekNo}`;
      try {
        const collRef = collection(db, collName);
        // Probe existence once; if no docs, show a gentle warning
        const snapProbe = await getDocs(collRef);
        if (snapProbe.empty){
          statusAlert.textContent = `No documents found in collection \"${collName}\". Double-check the week number or data in Firestore.`;
          statusAlert.classList.remove('d-none');
        }
        // Live subscribe
        unsubscribe = onSnapshot(collRef, (snapshot) => {
          const rows = [];
          snapshot.forEach(doc => {
            const data = doc.data() || {};
            rows.push({
              id: doc.id,
              name: doc.id, // Using doc id as the student's name as per your structure
              assignedTime: data.assignedTime ?? '',
              absent: data.absent ?? false,
              timeIn: data.timeIn ?? null,
              timeOut: data.timeOut ?? null,
            });
          });
          currentRows = rows.sort((a,b)=> a.name.localeCompare(b.name));
          liveBadge.textContent = 'ON';
          recomputeAndRender();
        }, (err) => {
          console.error(err);
          statusAlert.textContent = `Realtime subscription error: ${err.message}`;
          statusAlert.classList.remove('d-none');
        });
      } catch (e){
        console.error(e);
        statusAlert.textContent = `Failed to load data: ${e.message}`;
        statusAlert.classList.remove('d-none');
      }
    }

    // Export CSV
    function exportCSV(){
      const header = ['Name','Assigned Time','Time In','Time Out','Absent','Status'];
      const lines = [header.join(',')];
      for (const r of currentRows){
        const status = deriveStatus(r);
        const row = [
          r.name,
          r.assignedTime || '',
          asDateStr(r.timeIn),
          asDateStr(r.timeOut),
          r.absent === true ? 'Yes' : 'No',
          status.charAt(0).toUpperCase() + status.slice(1)
        ].map(v => '"' + String(v).replace(/"/g,'""') + '"');
        lines.push(row.join(','));
      }
      const blob = new Blob([lines.join('\n')], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `wk${currentWeek}-presence.csv`;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    }

    // Wire up UI
    loadBtn.addEventListener('click', () => {
      const wk = Number(weekInput.value);
      if (!Number.isInteger(wk) || wk < 1 || wk > 53){
        alert('Please enter a valid week number (1-53).');
        return;
        }
      currentWeek = wk;
      loadWeek(currentWeek);
      loadWeekLabel.textContent = currentWeek;
      const url = new URL(location.href);
      url.searchParams.set('week', String(currentWeek));
      history.replaceState(null, '', url);
    });

    exportCsvBtn.addEventListener('click', exportCSV);
    searchInput.addEventListener('input', () => renderTable(currentRows));
    statusFilter.addEventListener('change', () => renderTable(currentRows));

    // First load
    loadWeek(currentWeek);
  </script>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
</body>
</html>
